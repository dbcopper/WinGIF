# å½•åˆ¶è¾¹æ¡†æ˜¾ç¤ºä¿®å¤

## âœ… å·²ä¿®å¤é—®é¢˜

### å½•åˆ¶æ—¶ä¸æ˜¾ç¤ºé€‰åŒºè¾¹æ¡†

**é—®é¢˜æè¿°**ï¼š
- æ‰‹åŠ¨é€‰æ‹©åŒºåŸŸåå¼€å§‹å½•åˆ¶
- å½•åˆ¶è¿‡ç¨‹ä¸­çœ‹ä¸åˆ°é€‰åŒºè¾¹æ¡†
- æ— æ³•ç¡®è®¤æ­£åœ¨å½•åˆ¶å“ªä¸ªåŒºåŸŸ

**æ ¹æœ¬åŸå› **ï¼š
ç°ä»£åŒ–ç‰ˆæœ¬ï¼ˆeguiï¼‰ä¸­ï¼Œå½•åˆ¶è¾¹æ¡†çš„æ˜¾ç¤ºå’Œé”€æ¯é€»è¾‘æ²¡æœ‰è¢«è°ƒç”¨ã€‚è™½ç„¶ `recording_outline_hwnd` å­—æ®µå­˜åœ¨ï¼Œä½†ç›¸å…³åŠŸèƒ½æœªå®ç°ã€‚

**ä¿®å¤å†…å®¹**ï¼š

### 1. å¯¼å…¥è¾¹æ¡†å‡½æ•°
```rust
use overlay::{
    show_recording_outline,      // æ˜¾ç¤ºè¾¹æ¡†
    destroy_recording_outline,    // é”€æ¯è¾¹æ¡†
    OverlayWindow,
    SelectionOutcome
};
```

### 2. åŒºåŸŸå½•åˆ¶æ—¶æ˜¾ç¤ºè¾¹æ¡†
åœ¨ `on_record_click` å‡½æ•°ä¸­ï¼Œå½“é€‰æ‹©åŒºåŸŸåï¼š
```rust
{
    let mut state = ui_state.lock();
    state.state_machine.start_recording(session);
    state.status_text = "å½•åˆ¶ä¸­...".to_string();
    state.frame_count = 0;

    // æ˜¾ç¤ºå½•åˆ¶è¾¹æ¡†
    if let Ok(outline_hwnd) = show_recording_outline(rect) {
        state.recording_outline_hwnd = outline_hwnd;
    }
}
```

### 3. çª—å£å½•åˆ¶æ—¶æ˜¾ç¤ºè¾¹æ¡†
çª—å£æ•è·æ—¶åŒæ ·æ˜¾ç¤ºè¾¹æ¡†ï¼š
```rust
{
    let mut state = ui_state.lock();
    state.state_machine.start_recording(session);
    state.status_text = "å½•åˆ¶ä¸­...".to_string();
    state.frame_count = 0;

    // æ˜¾ç¤ºå½•åˆ¶è¾¹æ¡†
    if let Ok(outline_hwnd) = show_recording_outline(rect) {
        state.recording_outline_hwnd = outline_hwnd;
    }
}
```

### 4. åœæ­¢å½•åˆ¶æ—¶é”€æ¯è¾¹æ¡†
åœ¨ `on_stop_click` å‡½æ•°ä¸­ï¼š
```rust
fn on_stop_click(ui_state: Arc<Mutex<EguiUiState>>, cmd_tx: Sender<CaptureCommand>) {
    let _ = cmd_tx.send(CaptureCommand::Stop);

    {
        let mut state = ui_state.lock();
        state.state_machine.stop_recording();
        state.status_text = "å½•åˆ¶å®Œæˆ".to_string();

        // é”€æ¯å½•åˆ¶è¾¹æ¡†
        if state.recording_outline_hwnd != 0 {
            destroy_recording_outline(state.recording_outline_hwnd);
            state.recording_outline_hwnd = 0;
        }
    }
}
```

### 5. é”™è¯¯æ—¶é”€æ¯è¾¹æ¡†
åœ¨ `result_handler` é”™è¯¯å¤„ç†ä¸­ï¼š
```rust
Ok(CaptureResult::Error(msg)) => {
    let mut state = ui_state.lock();
    state.status_text = format!("é”™è¯¯: {}", msg);

    // é”€æ¯å½•åˆ¶è¾¹æ¡†
    if state.recording_outline_hwnd != 0 {
        destroy_recording_outline(state.recording_outline_hwnd);
        state.recording_outline_hwnd = 0;
    }

    // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    if let Some(session) = state.state_machine.session() {
        let _ = std::fs::remove_dir_all(&session.temp_dir);
    }

    state.state_machine.reset();
}
```

## è¾¹æ¡†ç‰¹æ€§

### è§†è§‰æ•ˆæœ
- **é¢œè‰²**ï¼šç»¿è‰²è¾¹æ¡†ï¼ˆ#00FF00ï¼‰
- **çº¿å®½**ï¼š2 åƒç´ 
- **æ ·å¼**ï¼šå®çº¿çŸ©å½¢
- **ä½ç½®**ï¼šç²¾ç¡®è¦†ç›–é€‰æ‹©çš„å½•åˆ¶åŒºåŸŸ

### æŠ€æœ¯å®ç°
- **çª—å£ç±»å‹**ï¼šç½®é¡¶é€æ˜å·¥å…·çª—å£
- **äº¤äº’**ï¼šç‚¹å‡»ç©¿é€ï¼ˆWS_EX_TRANSPARENTï¼‰
- **æ¸²æŸ“**ï¼šGDI Rectangle ç»˜åˆ¶
- **ç”Ÿå‘½å‘¨æœŸ**ï¼š
  - åˆ›å»ºï¼šå½•åˆ¶å¼€å§‹æ—¶
  - é”€æ¯ï¼šå½•åˆ¶åœæ­¢/å–æ¶ˆ/å‡ºé”™æ—¶

### è¾¹æ¡†çª—å£å±æ€§
```rust
WS_EX_TOPMOST       // å§‹ç»ˆç½®é¡¶
WS_EX_TOOLWINDOW    // å·¥å…·çª—å£ï¼ˆä¸åœ¨ä»»åŠ¡æ æ˜¾ç¤ºï¼‰
WS_EX_TRANSPARENT   // é¼ æ ‡ç©¿é€
WS_EX_NOACTIVATE    // ä¸æ¿€æ´»çª—å£
WS_POPUP            // å¼¹å‡ºçª—å£ï¼ˆæ— æ ‡é¢˜æ ï¼‰
```

## ç”¨æˆ·ä½“éªŒæ”¹è¿›

### ä¹‹å‰
âŒ å½•åˆ¶æ—¶çœ‹ä¸åˆ°è¾¹æ¡†
âŒ ä¸çŸ¥é“æ­£åœ¨å½•åˆ¶å“ªä¸ªåŒºåŸŸ
âŒ å¯èƒ½æ„å¤–å½•åˆ¶é”™è¯¯çš„å†…å®¹

### ç°åœ¨
âœ… **æ¸…æ™°çš„ç»¿è‰²è¾¹æ¡†**æŒ‡ç¤ºå½•åˆ¶åŒºåŸŸ
âœ… **å®æ—¶æ˜¾ç¤º**ï¼Œå½•åˆ¶æœŸé—´ä¸€ç›´å¯è§
âœ… **è‡ªåŠ¨æ¸…ç†**ï¼Œåœæ­¢å½•åˆ¶åè¾¹æ¡†æ¶ˆå¤±
âœ… **ç‚¹å‡»ç©¿é€**ï¼Œä¸å½±å“é¼ æ ‡æ“ä½œ

## æµ‹è¯•æ­¥éª¤

1. **å¯åŠ¨ç¨‹åº**
   ```cmd
   cargo run --bin tinycapture-modern
   ```

2. **å¼€å§‹å½•åˆ¶**
   - ç‚¹å‡»ã€ŒğŸ”´ å½•åˆ¶ã€æŒ‰é’®
   - æ‹–åŠ¨é€‰æ‹©ä¸€ä¸ªåŒºåŸŸ
   - æŒ‰ Enter ç¡®è®¤

3. **æ£€æŸ¥è¾¹æ¡†**
   - âœ… åº”è¯¥çœ‹åˆ°ç»¿è‰²è¾¹æ¡†å›´ç»•é€‰åŒº
   - âœ… è¾¹æ¡†åº”è¯¥ä¸€ç›´æ˜¾ç¤º
   - âœ… å¯ä»¥é€šè¿‡è¾¹æ¡†ç‚¹å‡»ä¸‹æ–¹çª—å£

4. **åœæ­¢å½•åˆ¶**
   - ç‚¹å‡»ã€Œâ¹ åœæ­¢ã€æŒ‰é’®
   - âœ… è¾¹æ¡†åº”è¯¥ç«‹å³æ¶ˆå¤±

5. **æµ‹è¯•çª—å£æ•è·**
   - ç‚¹å‡»ã€Œå½•åˆ¶ã€
   - ç‚¹å‡»é€‰æ‹©ä¸€ä¸ªçª—å£
   - âœ… çª—å£å‘¨å›´åº”æ˜¾ç¤ºç»¿è‰²è¾¹æ¡†

6. **æµ‹è¯•é”™è¯¯æƒ…å†µ**
   - å¼€å§‹å½•åˆ¶
   - æ¨¡æ‹Ÿé”™è¯¯ï¼ˆå¦‚å…³é—­è¢«å½•åˆ¶çš„çª—å£ï¼‰
   - âœ… è¾¹æ¡†åº”è¯¥åœ¨é”™è¯¯æ—¶è‡ªåŠ¨æ¸…ç†

## å·²ä¿®æ”¹æ–‡ä»¶

- âœ… `crates/app/src/main_egui.rs`
  - å¯¼å…¥è¾¹æ¡†å‡½æ•°
  - å½•åˆ¶å¼€å§‹æ—¶æ˜¾ç¤ºè¾¹æ¡†
  - åœæ­¢/é”™è¯¯æ—¶é”€æ¯è¾¹æ¡†

## æ„å»ºå’Œè¿è¡Œ

```cmd
# æ„å»º Debug ç‰ˆæœ¬ï¼ˆå¿«é€Ÿæµ‹è¯•ï¼‰
cargo build --bin tinycapture-modern

# è¿è¡Œ
cargo run --bin tinycapture-modern

# æ„å»º Release ç‰ˆæœ¬ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
cargo build --release --bin tinycapture-modern
```

## æ³¨æ„äº‹é¡¹

1. **è¾¹æ¡†çª—å£ç®¡ç†**
   - è¾¹æ¡†æ˜¯ç‹¬ç«‹çš„ Win32 çª—å£
   - ä¸ä¼šå¹²æ‰°å½•åˆ¶è¿‡ç¨‹
   - å†…å­˜å ç”¨æå°

2. **å¤šæ˜¾ç¤ºå™¨æ”¯æŒ**
   - è¾¹æ¡†ä¼šæ­£ç¡®æ˜¾ç¤ºåœ¨å¯¹åº”çš„æ˜¾ç¤ºå™¨ä¸Š
   - åæ ‡ä½¿ç”¨ç‰©ç†åƒç´ ï¼ˆPer-Monitor DPI V2ï¼‰

3. **çº¿ç¨‹å®‰å…¨**
   - `recording_outline_hwnd` é€šè¿‡ Mutex ä¿æŠ¤
   - å¯ä»¥ä»ä»»ä½•çº¿ç¨‹å®‰å…¨è°ƒç”¨

## ä¸åŸå§‹ç‰ˆæœ¬å¯¹æ¯”

åŸå§‹ GDI ç‰ˆæœ¬å·²ç»æœ‰æ­¤åŠŸèƒ½ï¼Œç°åœ¨ç°ä»£åŒ– egui ç‰ˆæœ¬ä¹ŸåŒæ ·æ”¯æŒï¼š

| åŠŸèƒ½ | åŸå§‹ç‰ˆæœ¬ | ç°ä»£åŒ–ç‰ˆæœ¬ |
|------|---------|-----------|
| å½•åˆ¶è¾¹æ¡†æ˜¾ç¤º | âœ… | âœ… å·²ä¿®å¤ |
| è¾¹æ¡†æ ·å¼ | ç»¿è‰² 2px | ç»¿è‰² 2px |
| è‡ªåŠ¨æ¸…ç† | âœ… | âœ… |
| å¤šæ˜¾ç¤ºå™¨æ”¯æŒ | âœ… | âœ… |

## æ€»ç»“

âœ… **åŠŸèƒ½å·²å®Œå…¨ä¿®å¤**
- å½•åˆ¶æ—¶æ­£ç¡®æ˜¾ç¤ºè¾¹æ¡†
- åœæ­¢æ—¶è‡ªåŠ¨æ¸…ç†
- é”™è¯¯æ—¶ä¹Ÿèƒ½æ­£ç¡®æ¸…ç†

âœ… **ç”¨æˆ·ä½“éªŒæå‡**
- æ¸…æ™°çŸ¥é“æ­£åœ¨å½•åˆ¶çš„åŒºåŸŸ
- é¿å…å½•åˆ¶é”™è¯¯å†…å®¹
- ä¸“ä¸šçš„è§†è§‰åé¦ˆ

ç°åœ¨å¯ä»¥æ„‰å¿«åœ°ä½¿ç”¨è¾¹æ¡†æŒ‡ç¤ºåŠŸèƒ½äº†ï¼ğŸ‰
